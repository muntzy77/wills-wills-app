<!DOCTYPE html>
<html lang="en-AU">
<head>
  <meta charset="UTF-8" />
  <title>Will's Wills | Full System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Updated fonts for a modern, playful aesthetic -->
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /*
      Modern fintech/lifestyle theme inspired by apps like Lemonade, Robinhood and CashApp.
      Dark mode base with soft pastel accents and playful typography.
    */
    :root {
      /*
        Updated colour palette for a completely original aesthetic. The new scheme leans into
        rich blues and sea‑tones offset with a coral pop of colour. These values are unique
        to Will’s Wills and move away from the neon lime/violet combination associated with
        other apps. The muted text colour softens long passages against the dark canvas.  
      */
      --bg: #0c1a2b;      /* deep navy with hints of green */
      --card-bg: rgba(255,255,255,0.04); /* subtle translucent card background */
      --card-border: rgba(255,255,255,0.12);
      --primary-text: #f5f7fa;
      --muted-text: #7b8fa6;
      --accent: #e85d75; /* warm coral for primary calls to action */
      --accent2: #4ecdc4; /* aqua‑teal for secondary highlights */
      --error: #ed4c67;  /* reddish pink for error states */
      --success: #45b69c; /* calm green for success messages */
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Plus Jakarta Sans', sans-serif;
    }
    body {
      background: var(--bg);
      color: var(--primary-text);
      line-height: 1.6;
    }
    header {
      backdrop-filter: blur(10px);
      background: rgba(15, 23, 42, 0.6);
      border-bottom: 1px solid var(--card-border);
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      font-family: 'Space Grotesk', sans-serif;
      font-weight: 700;
      font-size: 1.6rem;
      color: var(--primary-text);
      text-transform: lowercase;
    }
    .logo span {
      color: var(--accent);
    }
    /* Navigation links */
    .nav-links {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-left: 1rem;
    }
    .nav-links a {
      color: var(--muted-text);
      text-decoration: none;
      font-weight: 500;
      font-size: 0.95rem;
      text-transform: capitalize;
    }
    .nav-links a:hover {
      color: var(--accent);
    }
    .btn {
      border-radius: 999px;
      padding: 0.7rem 1.6rem;
      border: none;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.95rem;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
    }
    .btn-primary {
      background: var(--accent);
      color: var(--bg);
      box-shadow: 0 0 12px rgba(204, 255, 0, 0.4);
    }
    .btn-accent {
      background: var(--accent2);
      color: var(--bg);
      box-shadow: 0 0 12px rgba(139, 92, 246, 0.4);
    }
    .btn-ghost {
      background: transparent;
      border: 1px solid var(--card-border);
      color: var(--muted-text);
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
    }
    .btn:active {
      transform: scale(0.98);
    }
    .container {
      max-width: 700px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      padding: 2rem;
      margin-bottom: 1.5rem;
      backdrop-filter: blur(10px);
    }
    h2 {
      margin-bottom: 1rem;
      font-family: 'Space Grotesk', sans-serif;
      font-weight: 600;
      font-size: 1.4rem;
      text-transform: sentence-case;
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--card-border);
      margin-bottom: 1.5rem;
    }
    .tab {
      padding: 0.8rem 1.6rem;
      cursor: pointer;
      font-weight: 500;
      color: var(--muted-text);
      position: relative;
    }
    .tab.active {
      color: var(--accent);
    }
    .tab.active::after {
      content: "";
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--accent);
      border-radius: 2px;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.2rem;
    }
    .field {
      margin-bottom: 1.2rem;
    }
    label {
      font-weight: 500;
      font-size: 0.9rem;
      margin-bottom: 0.4rem;
      display: block;
      color: var(--muted-text);
    }
    input, select, textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--card-border);
      padding: 0.8rem 1rem;
      font-size: 0.9rem;
      color: var(--primary-text);
      background: rgba(255,255,255,0.04);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(204, 255, 0, 0.3);
    }
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    .muted {
      font-size: 0.85rem;
      color: var(--muted-text);
      margin-top: 0.25rem;
    }
    .error {
      color: var(--error);
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }
    .success {
      color: var(--success);
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }
    pre.will-output {
      white-space: pre-wrap;
      background: rgba(255,255,255,0.04);
      border-radius: 16px;
      border: 1px solid var(--card-border);
      padding: 1rem;
      max-height: 300px;
      overflow: auto;
      font-size: 0.9rem;
    }
    .section-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary-text);
      margin: 1.4rem 0 0.6rem;
    }

    /* Hero section for prominent call‑to‑action */
    .hero {
      text-align: center;
      margin: 3rem auto 2rem;
      max-width: 800px;
    }
    .hero h1 {
      font-family: 'Space Grotesk', sans-serif;
      font-weight: 700;
      font-size: 2.2rem;
      margin-bottom: 0.8rem;
      color: var(--primary-text);
    }
    .hero .subtitle {
      color: var(--muted-text);
      font-size: 1.1rem;
      margin-bottom: 1.5rem;
    }
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
      }
    }
  </style>
</head>
<body>
<header>
  <div class="logo">Will's<span>Wills</span></div>
  <!-- Navigation links for secondary pages -->
  <nav class="nav-links">
    <a href="/about.html">About</a>
    <a href="/terms.html">Terms</a>
    <a href="/contact.html">Contact</a>
    <a href="/planning.html">Estate&nbsp;Planning</a>
    <!-- Link to the user dashboard for viewing and amending saved wills -->
    <a href="/dashboard.html">Dashboard</a>
  </nav>
  <div>
    <button id="btn-logout" class="btn btn-ghost" style="display:none;">Log Out</button>
  </div>
</header>

<div class="container">
  <!-- Hero Section introducing the service and call to action -->
  <div id="hero" class="hero">
    <!-- A fresh, original headline that speaks to leaving a meaningful legacy -->
    <h1>Plan with heart.<br>Leave your mark.</h1>
    <p class="subtitle">Estate planning made simple and soulful.</p>
    <button id="btn-get-started" class="btn btn-accent">Start planning</button>
  </div>

  <!-- Auth Card -->
  <div class="card" id="auth-card">
    <div class="tabs">
      <div class="tab active" id="tab-login">Log In</div>
      <div class="tab" id="tab-signup">Sign Up</div>
    </div>
    <div id="auth-error" class="error" style="display:none;"></div>
    <div id="auth-success" class="success" style="display:none;"></div>

    <div id="login-form">
      <div class="field">
        <label>Email</label>
        <input type="email" id="login-email" placeholder="you@example.com">
      </div>
      <div class="field">
        <label>Password</label>
        <input type="password" id="login-password" placeholder="••••••••">
      </div>
      <button class="btn btn-primary" id="btn-login">Log In</button>
    </div>

    <div id="signup-form" style="display:none;">
      <div class="grid">
        <div class="field">
          <label>Username</label>
          <input type="text" id="signup-username" placeholder="Riley">
        </div>
        <div class="field">
          <label>Email</label>
          <input type="email" id="signup-email" placeholder="you@example.com">
        </div>
      </div>
      <div class="grid">
        <div class="field">
          <label>Phone</label>
          <input type="tel" id="signup-phone" placeholder="04XX XXX XXX">
        </div>
        <div class="field">
          <label>Password</label>
          <input type="password" id="signup-password" placeholder="Min 8 characters">
        </div>
      </div>
      <p class="muted">On signup, a confirmation email will be sent with your account details.</p>
      <button class="btn btn-accent" id="btn-signup">Create Account</button>
    </div>
  </div>

  <!-- App Card (hidden by default; revealed after subscription) -->
  <div class="card" id="app-card" style="display:none;">
    <h2>Will Questionnaire</h2>
    <p class="muted" style="margin-bottom:1rem;">
      Answer the questions below. You’ll get a customised AI-generated Australian Will draft at the end.
    </p>

    <div class="section-title">Core Details</div>
    <div class="grid">
      <div class="field">
        <label>Full Legal Name</label>
        <input id="fullName" placeholder="e.g. Riley James Chen">
      </div>
      <div class="field">
        <label>Residential Address</label>
        <input id="address" placeholder="Unit 5, 20 Beach Rd, Bondi NSW 2026">
      </div>
    </div>

    <div class="grid">
      <div class="field">
        <label>State / Territory</label>
        <select id="state">
          <option value="">Select…</option>
          <option>NSW</option>
          <option>VIC</option>
          <option>QLD</option>
          <option>WA</option>
          <option>SA</option>
          <option>TAS</option>
          <option>ACT</option>
          <option>NT</option>
        </select>
      </div>
      <div class="field">
        <label>Marital Status</label>
        <select id="maritalStatus">
          <option value="">Select…</option>
          <option>Never Married</option>
          <option>Married</option>
          <option>De Facto</option>
          <option>Separated</option>
          <option>Divorced</option>
          <option>Widowed</option>
        </select>
      </div>
    </div>

    <div class="field">
      <label>Do you have children (including step/adopted)?</label>
      <select id="hasChildren">
        <option value="no">No</option>
        <option value="yes">Yes</option>
      </select>
    </div>

    <div class="section-title">Executor & Contacts</div>
    <div class="grid">
      <div class="field">
        <label>Executor - Full Name</label>
        <input id="executorName" placeholder="e.g. Clara Smith">
      </div>
      <div class="field">
        <label>Executor - Contact Details</label>
        <input id="executorContact" placeholder="Address / phone / email">
      </div>
    </div>

    <div class="grid">
      <div class="field">
        <label>Next of Kin / Nominated Person</label>
        <input id="nextOfKinName" placeholder="e.g. Partner, sibling, trusted friend">
        <p class="muted">This person is a practical first contact after death.</p>
      </div>
      <div class="field">
        <label>Next of Kin Contact</label>
        <input id="nextOfKinContact" placeholder="Phone / email / address">
      </div>
    </div>

    <div class="grid">
      <div class="field">
        <label>Preferred Lawyer (optional)</label>
        <input id="lawyerName" placeholder="Firm or person">
      </div>
      <div class="field">
        <label>Lawyer Contact (optional)</label>
        <input id="lawyerContact" placeholder="Phone / email / address">
      </div>
    </div>

    <div class="section-title">Estate & Wishes</div>
    <div class="field">
      <label>Assets Summary (dropdown-style overview)</label>
      <select id="assetsPreset">
        <option value="">Select a rough profile…</option>
        <option value="home-super-vehicles">Own home + super + one or more vehicles</option>
        <option value="renting-super-savings">Renting + super + savings</option>
        <option value="multiple-properties-business">Multiple properties + business interests</option>
        <option value="simple-assets">Very simple assets (small savings / belongings only)</option>
      </select>
      <textarea id="assetsSummary" placeholder="Add any detail: property addresses, major accounts, business interests, etc."></textarea>
    </div>

    <div class="field">
      <label>Beneficiaries Summary (who gets what, in plain language)</label>
      <select id="beneficiariesPreset">
        <option value="">Select a common pattern…</option>
        <option value="all-to-partner">Everything to my spouse/partner</option>
        <option value="partner-then-children">To partner, then to children equally if partner predeceases</option>
        <option value="children-equally">Children equally</option>
        <option value="charities-mix">Mix of family + charities</option>
      </select>
      <textarea id="beneficiariesSummary" placeholder="e.g. My spouse Jane Smith to receive my entire estate; if she does not survive me, then to my children equally."></textarea>
    </div>

    <div class="field">
      <label>Funeral Wishes (non-binding)</label>
      <textarea id="funeralWishes" placeholder="Burial/cremation, ceremony style, location, music, etc."></textarea>
    </div>

    <div class="field">
      <label>Custom Instructions / Special Clauses</label>
      <textarea id="customInstructions" placeholder="Anything you want to be expressed in your own words (pets, digital assets, specific bequests, etc.)."></textarea>
    </div>

    <div id="will-error" class="error" style="display:none;"></div>
    <div id="will-success" class="success" style="display:none;"></div>
    <button class="btn btn-primary" id="btn-generate">Generate My Will</button>

    <div class="section-title" style="margin-top:1.5rem;">Generated Will Draft</div>
    <!-- The will output will be shown here after generation. Hidden until subscription is confirmed. -->
    <pre class="will-output" id="will-output">No will generated yet.</pre>

    <!-- Paywall prompt shown when the user has not subscribed yet. This asks for a yearly fee before revealing the will. -->
    <div id="paywall" style="display:none;margin-top:1rem;padding:1rem;background:rgba(139,92,246,0.12);border:1px solid var(--accent2);border-radius:16px;">
      <p style="margin-bottom:1rem;color:var(--primary-text);">To access your full will draft, please subscribe for <strong>AUD $30 per year</strong>. This subscription supports secure storage and future amendments.</p>
      <button class="btn btn-accent" id="btn-subscribe">Subscribe for AUD $30/year</button>
    </div>
  </div>

  <!-- Third-party access card -->
  <div class="card" id="access-card" style="display:none;">
    <h2>Third-Party Will Access (Death-Certificate Gate)</h2>
    <p class="muted" style="margin-bottom:1rem;">
      This simulates a lawyer / next of kin requesting read-only access to a stored will.  
      Use certificate number <code>TEST-OK</code> to simulate a valid Australian death certificate.
    </p>
    <div class="grid">
      <div class="field">
        <label>Deceased Full Name (must match testator name exactly)</label>
        <input id="access-deceasedName" placeholder="e.g. Riley James Chen">
      </div>
      <div class="field">
        <label>Death Certificate Number</label>
        <input id="access-certNumber" placeholder="e.g. TEST-OK">
      </div>
    </div>
    <div class="grid">
      <div class="field">
        <label>Date of Birth of Deceased (ISO format)</label>
        <input id="access-dob" placeholder="YYYY-MM-DD">
      </div>
      <div class="field">
        <label>Your Email (requester)</label>
        <input id="access-email" placeholder="lawyer@example.com">
      </div>
    </div>
    <div id="access-error" class="error" style="display:none;"></div>
    <div id="access-success" class="success" style="display:none;"></div>
    <button class="btn btn-accent" id="btn-request-access">Request Access</button>

    <div class="section-title" style="margin-top:1.5rem;">Access Result (Stubbed)</div>
    <pre class="will-output" id="access-output">No request made yet.</pre>
  </div>
</div>

<script>
  // Base URL for API calls; empty string means same origin
  const API_BASE = "";

  let authToken = localStorage.getItem("wills_token") || null;

  const authCard = document.getElementById("auth-card");
  const appCard = document.getElementById("app-card");
  const accessCard = document.getElementById("access-card");
  const btnLogout = document.getElementById("btn-logout");

  const authError = document.getElementById("auth-error");
  const authSuccess = document.getElementById("auth-success");

  const willError = document.getElementById("will-error");
  const willSuccess = document.getElementById("will-success");
  const willOutput = document.getElementById("will-output");
  const paywall = document.getElementById("paywall");
  const btnSubscribe = document.getElementById("btn-subscribe");

  // Hide the will output initially
  willOutput.style.display = "none";

  const accessError = document.getElementById("access-error");
  const accessSuccess = document.getElementById("access-success");
  const accessOutput = document.getElementById("access-output");

  // Elements for hero section and Get Started gating
  const hero = document.getElementById("hero");
  const btnGetStarted = document.getElementById("btn-get-started");

  function setLoggedInState(loggedIn) {
    if (loggedIn) {
      // Hide authentication forms once logged in
      authCard.style.display = "none";
      // Do not automatically reveal the questionnaire; user must click Get Started and subscribe
      appCard.style.display = "none";
      accessCard.style.display = "none";
      paywall.style.display = "none";
      btnLogout.style.display = "inline-flex";
      // Pre‑fill the questionnaire data so it is ready when shown later
      prefillFromSaved();
    } else {
      // Show authentication when logged out
      authCard.style.display = "block";
      appCard.style.display = "none";
      accessCard.style.display = "none";
      paywall.style.display = "none";
      btnLogout.style.display = "none";
      // Reset hero visibility
      hero.style.display = "block";
      // Ensure will output and paywall are hidden until logged in
      willOutput.style.display = "none";
    }
  }

  if (authToken) {
    setLoggedInState(true);
  } else {
    setLoggedInState(false);
  }

  /**
   * Load saved form data from localStorage and prefill the questionnaire inputs. When a user revisits the
   * questionnaire after creating a will, this helps them amend details without starting from scratch.
   */
  function prefillFromSaved() {
    try {
      const saved = localStorage.getItem("savedWillData");
      if (!saved) return;
      const d = JSON.parse(saved);
      document.getElementById("fullName").value = d.fullName || "";
      document.getElementById("address").value = d.address || "";
      document.getElementById("state").value = d.state || "";
      document.getElementById("maritalStatus").value = d.maritalStatus || "";
      document.getElementById("hasChildren").value = d.hasChildren ? "yes" : "no";
      document.getElementById("executorName").value = d.executorName || "";
      document.getElementById("executorContact").value = d.executorContact || "";
      document.getElementById("nextOfKinName").value = d.nextOfKinName || "";
      document.getElementById("nextOfKinContact").value = d.nextOfKinContact || "";
      document.getElementById("lawyerName").value = d.lawyerName || "";
      document.getElementById("lawyerContact").value = d.lawyerContact || "";
      document.getElementById("assetsSummary").value = d.assetsSummary || "";
      document.getElementById("beneficiariesSummary").value = d.beneficiariesSummary || "";
      document.getElementById("funeralWishes").value = d.funeralWishes || "";
      document.getElementById("customInstructions").value = d.customInstructions || "";
    } catch (e) {
      console.warn("Failed to prefill saved data", e);
    }
  }

  // Tabs
  const tabLogin = document.getElementById("tab-login");
  const tabSignup = document.getElementById("tab-signup");
  const loginForm = document.getElementById("login-form");
  const signupForm = document.getElementById("signup-form");

  tabLogin.addEventListener("click", () => {
    tabLogin.classList.add("active");
    tabSignup.classList.remove("active");
    loginForm.style.display = "block";
    signupForm.style.display = "none";
    authError.style.display = "none";
    authSuccess.style.display = "none";
  });

  tabSignup.addEventListener("click", () => {
    tabSignup.classList.add("active");
    tabLogin.classList.remove("active");
    loginForm.style.display = "none";
    signupForm.style.display = "block";
    authError.style.display = "none";
    authSuccess.style.display = "none";
  });

  // Signup
  document.getElementById("btn-signup").addEventListener("click", async () => {
    authError.style.display = "none";
    authSuccess.style.display = "none";
    const username = document.getElementById("signup-username").value.trim();
    const email = document.getElementById("signup-email").value.trim();
    const phone = document.getElementById("signup-phone").value.trim();
    const password = document.getElementById("signup-password").value.trim();

    if (!username || !email || !phone || !password) {
      authError.textContent = "All fields are required.";
      authError.style.display = "block";
      return;
    }

    try {
      const res = await fetch(API_BASE + "/api/auth/signup", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, email, phone, password })
      });
      const data = await res.json();
      if (!res.ok) {
        authError.textContent = data.error || "Signup failed.";
        authError.style.display = "block";
        return;
      }
      authToken = data.token;
      localStorage.setItem("wills_token", authToken);
      authSuccess.textContent = "Account created. Confirmation email (stubbed) sent. You are now logged in.";
      authSuccess.style.display = "block";
      setLoggedInState(true);
    } catch (err) {
      authError.textContent = "Network error.";
      authError.style.display = "block";
    }
  });

  // Login
  document.getElementById("btn-login").addEventListener("click", async () => {
    authError.style.display = "none";
    authSuccess.style.display = "none";

    const email = document.getElementById("login-email").value.trim();
    const password = document.getElementById("login-password").value.trim();
    if (!email || !password) {
      authError.textContent = "Email and password required.";
      authError.style.display = "block";
      return;
    }

    try {
      const res = await fetch(API_BASE + "/api/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password })
      });
      const data = await res.json();
      if (!res.ok) {
        authError.textContent = data.error || "Login failed.";
        authError.style.display = "block";
        return;
      }
      authToken = data.token;
      localStorage.setItem("wills_token", authToken);
      authSuccess.textContent = "Logged in successfully.";
      authSuccess.style.display = "block";
      setLoggedInState(true);
    } catch (err) {
      authError.textContent = "Network error.";
      authError.style.display = "block";
    }
  });

  // Logout
  btnLogout.addEventListener("click", () => {
    authToken = null;
    localStorage.removeItem("wills_token");
    willOutput.textContent = "No will generated yet.";
    accessOutput.textContent = "No request made yet.";
    setLoggedInState(false);
  });

  // Assets preset updates assetsSummary
  document.getElementById("assetsPreset").addEventListener("change", (e) => {
    const val = e.target.value;
    const field = document.getElementById("assetsSummary");
    if (!val) return;
    if (val === "home-super-vehicles") {
      field.value = (field.value + "\nOwn home, standard superannuation, and one or more vehicles.").trim();
    } else if (val === "renting-super-savings") {
      field.value = (field.value + "\nRenting, with primary assets being superannuation and cash savings.").trim();
    } else if (val === "multiple-properties-business") {
      field.value = (field.value + "\nMultiple properties and one or more business interests.").trim();
    } else if (val === "simple-assets") {
      field.value = (field.value + "\nLimited assets: small savings and personal belongings.").trim();
    }
    e.target.value = "";
  });

  // Beneficiaries preset updates beneficiariesSummary
  document.getElementById("beneficiariesPreset").addEventListener("change", (e) => {
    const val = e.target.value;
    const field = document.getElementById("beneficiariesSummary");
    if (!val) return;
    if (val === "all-to-partner") {
      field.value = "I give my entire estate to my spouse/partner, provided they survive me by 30 days.";
    } else if (val === "partner-then-children") {
      field.value = "I give my estate to my spouse/partner, provided they survive me by 30 days; if not, then to my children in equal shares.";
    } else if (val === "children-equally") {
      field.value = "I give my estate to my children in equal shares, with any deceased child's share passing to their children (if any).";
    } else if (val === "charities-mix") {
      field.value = "I give the majority of my estate to my immediate family, with a portion to one or more named charities.";
    }
    e.target.value = "";
  });

  // Generate Will
  document.getElementById("btn-generate").addEventListener("click", async () => {
    willError.style.display = "none";
    willSuccess.style.display = "none";

    if (!authToken) {
      willError.textContent = "You must be logged in.";
      willError.style.display = "block";
      return;
    }

    const payload = {
      fullName: document.getElementById("fullName").value.trim(),
      address: document.getElementById("address").value.trim(),
      state: document.getElementById("state").value,
      maritalStatus: document.getElementById("maritalStatus").value,
      hasChildren: document.getElementById("hasChildren").value === "yes",
      executorName: document.getElementById("executorName").value.trim(),
      executorContact: document.getElementById("executorContact").value.trim(),
      nextOfKinName: document.getElementById("nextOfKinName").value.trim(),
      nextOfKinContact: document.getElementById("nextOfKinContact").value.trim(),
      lawyerName: document.getElementById("lawyerName").value.trim(),
      lawyerContact: document.getElementById("lawyerContact").value.trim(),
      assetsSummary: document.getElementById("assetsSummary").value.trim(),
      beneficiariesSummary: document.getElementById("beneficiariesSummary").value.trim(),
      funeralWishes: document.getElementById("funeralWishes").value.trim(),
      customInstructions: document.getElementById("customInstructions").value.trim()
    };

    if (!payload.fullName || !payload.address || !payload.state || !payload.maritalStatus || !payload.executorName) {
      willError.textContent = "Full name, address, state, marital status and executor are required.";
      willError.style.display = "block";
      return;
    }

    try {
      // First call the ChatGPT-driven endpoint to generate a will draft
      const aiRes = await fetch(API_BASE + "/api/generate-will", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + authToken
        },
        body: JSON.stringify(payload)
      });
      const aiData = await aiRes.json();
      if (!aiRes.ok) {
        willError.textContent = aiData.error || "Failed to generate will.";
        willError.style.display = "block";
        return;
      }

      // Then persist the will and user data via the existing /api/will route
      const saveRes = await fetch(API_BASE + "/api/will", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + authToken
        },
        body: JSON.stringify(payload)
      });
      const saveData = await saveRes.json();
      if (!saveRes.ok) {
        willError.textContent = saveData.error || "Failed to save will.";
        willError.style.display = "block";
        return;
      }

      // Save the form payload to localStorage for later amendments
      localStorage.setItem("savedWillData", JSON.stringify(payload));

      willSuccess.textContent = "Will generated and saved on server.";
      willSuccess.style.display = "block";

      // If the user is not subscribed yet, hide the will and show paywall
      const subscribed = localStorage.getItem("wills_subscribed") === "true";
      if (!subscribed) {
        willOutput.style.display = "none";
        paywall.style.display = "block";
      } else {
        paywall.style.display = "none";
        willOutput.style.display = "block";
      }
      // Display the AI-generated will text
      willOutput.textContent = aiData.willText || "No text returned.";
    } catch (err) {
      willError.textContent = "Network error.";
      willError.style.display = "block";
    }
  });

  // Handle subscription button: simulate payment and unlock the will
  btnSubscribe.addEventListener("click", () => {
    // In a real app, you would integrate a payment gateway here.
    // For demo purposes, we simply set a flag in localStorage and reveal the will.
    alert("Thank you for subscribing! Your annual subscription has been activated.");
    localStorage.setItem("wills_subscribed", "true");
    // Hide paywall and hero once subscribed
    hero.style.display = "none";
    paywall.style.display = "none";
    // Reveal questionnaire and third‑party access sections after subscription
    appCard.style.display = "block";
    accessCard.style.display = "block";
    willOutput.style.display = "block";
  });

  // Get Started button gating logic
  btnGetStarted.addEventListener("click", () => {
    // If the user is not logged in, prompt them to log in or sign up
    if (!authToken) {
      alert("Please log in or create an account before getting started.");
      // Smooth scroll to authentication card for convenience
      authCard.scrollIntoView({ behavior: "smooth" });
      return;
    }
    // Once logged in, check subscription status
    const subscribed = localStorage.getItem("wills_subscribed") === "true";
    // Hide hero and auth forms once the flow begins
    hero.style.display = "none";
    authCard.style.display = "none";
    if (!subscribed) {
      // Show paywall card when not subscribed
      paywall.style.display = "block";
      // Ensure questionnaire and access sections are hidden
      appCard.style.display = "none";
      accessCard.style.display = "none";
      willOutput.style.display = "none";
    } else {
      // Already subscribed: show questionnaire and access sections
      paywall.style.display = "none";
      appCard.style.display = "block";
      accessCard.style.display = "block";
      willOutput.style.display = "block";
    }
  });

  // Third-party access
  document.getElementById("btn-request-access").addEventListener("click", async () => {
    accessError.style.display = "none";
    accessSuccess.style.display = "none";

    const deceasedFullName = document.getElementById("access-deceasedName").value.trim();
    const certificateNumber = document.getElementById("access-certNumber").value.trim();
    const dob = document.getElementById("access-dob").value.trim();
    const requesterEmail = document.getElementById("access-email").value.trim();

    if (!deceasedFullName || !certificateNumber || !dob || !requesterEmail) {
      accessError.textContent = "All access fields are required.";
      accessError.style.display = "block";
      return;
    }

    try {
      const res = await fetch(API_BASE + "/api/will/request-access", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ deceasedFullName, certificateNumber, dob, requesterEmail })
      });
      const data = await res.json();
      if (!res.ok) {
        accessError.textContent = data.error || "Access request failed.";
        accessError.style.display = "block";
        accessOutput.textContent = JSON.stringify(data, null, 2);
        return;
      }
      accessSuccess.textContent = data.message || "Access granted (stub).";
      accessSuccess.style.display = "block";
      accessOutput.textContent = data.willText || JSON.stringify(data, null, 2);
    } catch (err) {
      accessError.textContent = "Network error.";
      accessError.style.display = "block";
    }
  });
</script>
</body>
</html>